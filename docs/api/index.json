{"repository_name":"artistry","body":"# Artistry\n\n**Artifact + Registry** - A SQLite-based datastore that lets disparate libraries and applications register their data needs and coexist harmoniously in a single database.\n\n## Core Concepts\n\n- **Registry** - Plugins register artifact kinds with schemas; each gets a unique short code (E for \"event\", U for \"user\", etc.)\n- **Unified Identity** - Global auto-increment IDs across all artifacts, addressable via slugs like `E42`\n- **JSON Payload** - Flexible schema stored as JSON, with expression indexes for performance\n- **Schema Validation** - JSON Schema subset with type checking, constraints, defaults, and optional fields\n- **COW Versioning** - Updates create new versions by default; full history preserved\n- **Links** - Cross-reference any artifact to any other with typed relations (auto-deleted with CASCADE)\n\n## Installation\n\nAdd to your `shard.yml`:\n\n```yaml\ndependencies:\n  artistry:\n    github: trans/artistry\n```\n\nThen run `shards install`.\n\n## Usage\n\n### Setup\n\n```crystal\nrequire \"artistry\"\n\n# Open database (creates tables if needed)\nArtistry.open(\"myapp.db\")\n\n# Or use an existing DB connection (Artistry won't close it)\nArtistry.open(existing_db)\n```\n\n### Register Artifact Kinds\n\nSchemas use a JSON Schema subset (powered by the [Jargon](https://github.com/trans/jargon) library):\n\n```crystal\nArtistry::Registry.register(\n  kind: \"event\",\n  plugin: \"myapp\",\n  schema: {\n    type: \"object\",\n    properties: {\n      title:    {type: \"string\", minLength: 1},\n      date:     {type: \"string\", format: \"date\"},\n      priority: {type: \"integer\", minimum: 1, maximum: 5},\n      status:   {type: \"string\", enum: [\"draft\", \"confirmed\"], default: \"draft\"},\n    },\n    required: [\"title\", \"date\"],\n    additionalProperties: false,\n  },\n  description: \"Calendar events\",\n  symbol: \"ðŸ“…\",                 # optional emoji for display\n  index: [\"title\", \"date\"]      # creates expression indexes\n)\n# => \"E\" (assigned code)\n```\n\n### Supported Schema Keywords\n\n| Category | Keywords |\n|----------|----------|\n| **Type** | `type` (`string`, `integer`, `number`, `boolean`, `array`, `object`, `null`) |\n| **Object** | `properties`, `required`, `additionalProperties` |\n| **String** | `minLength`, `maxLength`, `pattern`, `format` |\n| **Number** | `minimum`, `maximum`, `exclusiveMinimum`, `exclusiveMaximum`, `multipleOf` |\n| **Array** | `items`, `minItems`, `maxItems`, `uniqueItems` |\n| **General** | `enum`, `const`, `default`, `description` |\n| **Composition** | `$ref`, `$defs` |\n\nFields listed in `required` must be present. Fields not in `required` are optional. Use `default` to provide fallback values (applied on create and update, stored in artifact data). Set `additionalProperties: false` to reject unknown fields.\n\n### Create Artifacts\n\n```crystal\n# status defaults to \"draft\", priority is optional\nevent = Artistry::Artifact.create(\"event\", {\n  title: \"Team Meeting\",\n  date: \"2025-06-15\",\n})\n\nevent.slug       # => \"E1\"\nevent.id         # => 1\nevent[\"title\"]   # => \"Team Meeting\" (as JSON::Any)\nevent[\"status\"]  # => \"draft\" (applied from default)\n```\n\n### Validation\n\n```crystal\n# Invalid type - raises ValidationError\nArtistry::Artifact.create(\"event\", {title: 123, date: \"2025-06-15\"})\n# => ValidationError: title: expected String, got Int64\n\n# Constraint violation\nArtistry::Artifact.create(\"event\", {title: \"\", date: \"2025-06-15\"})\n# => ValidationError: title: must be at least 1 characters\n\n# Unknown field rejected (when additionalProperties: false)\nArtistry::Artifact.create(\"event\", {title: \"Test\", date: \"2025-06-15\", extra: \"x\"})\n# => ValidationError: extra: additionalProperties is false\n```\n\n### Query\n\n```crystal\n# By ID\nArtistry::Artifact.find(1)\n\n# By slug\nArtistry::Artifact.find(\"E1\")\n\n# By kind\nArtistry::Artifact.where(\"E\")\n\n# With conditions\nArtistry::Artifact.where(\"E\", priority: 1)\n```\n\n### Update (COW - default)\n\nCreates a new version, supersedes the old:\n\n```crystal\nv1 = Artistry::Artifact.create(\"event\", {title: \"Draft\", date: \"2025-06-15\"})\nv2 = v1.update({title: \"Final\"})\n\nv1.superseded?   # => true\nv2.current?      # => true\nv1.successor     # => v2\nv2.history       # => [v1, v2]\n```\n\n### Update (Mutable)\n\nModifies in place:\n\n```crystal\nartifact.update!({title: \"Changed\"})\nartifact.updated_at  # => unix milliseconds (Int64)\n```\n\n### Links\n\nLinks use `rel` (relation) to describe the relationship type:\n\n```crystal\nevent = Artistry::Artifact.create(\"event\", {title: \"Meeting\", date: \"2025-06-15\"})\nperson = Artistry::Artifact.create(\"person\", {name: \"Alice\"})\n\n# Create link with relation type\nArtistry::Link.create(event, person, \"organizer\")\nArtistry::Link.create(event, person, \"attendee\", {role: \"presenter\"})\n\n# Query links by relation\nArtistry::Link.from(event, \"attendee\")  # outgoing\nArtistry::Link.to(person, \"organizer\")  # incoming\n\n# Resolve linked artifacts\nlink = Artistry::Link.from(event).first\nlink.to   # => the person artifact\nlink.rel  # => \"attendee\"\n```\n\n### Tags\n\nTags are normalized â€” each unique tag string is stored once, then linked to artifacts via a junction table.\n\n```crystal\n# Tag an artifact\nArtistry::Tag.tag(event, \"security\")\nArtistry::Tag.tag(event, \"mvp\")\n\n# Get tags for an artifact\nArtistry::Tag.for(event)  # => [Tag(\"mvp\"), Tag(\"security\")]\n\n# Find artifacts by tag\nArtistry::Tag.artifacts(\"security\")\n\n# OR query - artifacts with any of the tags\nArtistry::Tag.artifacts_any([\"security\", \"mvp\"])\n\n# AND query - artifacts with all of the tags\nArtistry::Tag.artifacts_all([\"security\", \"mvp\"])\n\n# Replace all tags at once\nArtistry::Tag.sync(event, [\"v2\", \"released\"])\n\n# Remove a tag\nArtistry::Tag.untag(event, \"mvp\")\n```\n\n### Transactions\n\nWrap multiple operations in a transaction for atomicity. The block yields a transaction context with convenient shortcuts:\n\n```crystal\nArtistry.transaction do |art|\n  event = art.create(\"event\", {title: \"Meeting\"})\n  person = art.create(\"person\", {name: \"Alice\"})\n  art.link(event, person, \"organizer\")\n  art.tag(event, \"important\")\nend\n# Auto-commits on success, auto-rollbacks on exception\n```\n\nThe transaction context provides: `create`, `find`, `where`, `tag`, `untag`, `sync_tags`, `tags_for`, `link`, `unlink`, `links_from`, `links_to`, `rollback`, `commit`.\n\nCall `art.rollback` for explicit rollback, or raise `DB::Rollback` for a silent rollback (no exception propagated). Class methods (`Artistry::Artifact.create`, etc.) also work inside the block and participate in the same transaction.\n\n### Versioning Queries\n\n```crystal\n# Current versions only (default)\nArtistry::Artifact.where(\"E\")\n\n# Include superseded versions\nArtistry::Artifact.where(\"E\", include_superseded: true)\n```\n\n## Tables\n\n| Table | Purpose |\n|-------|---------|\n| `identity` | Global ID generator with `created_at` |\n| `registry` | Kind registrations (`code`, `kind`, `plugin`, `description`, `symbol`, `version`) |\n| `schema` | Versioned schemas with JSON and hash |\n| `artifact` | All artifacts (JSON payload, COW tracking via `new_id`) |\n| `link` | Cross-artifact references (`from_id`, `to_id`, `rel`, `data`) - CASCADE delete |\n| `tag` | Unique tag names (`id`, `name`) |\n| `tagging` | Junction table linking tags to artifacts - CASCADE delete both directions |\n\n## Technical Notes\n\n- **Timestamps**: All `created_at`/`updated_at` fields are unix epoch milliseconds (Int64). Convert with `Time.unix_ms(ts)` in Crystal.\n- **Foreign Keys**: FK constraints are enforced. Link and tagging FKs use `ON DELETE CASCADE` - deleting an artifact removes its links and taggings; deleting a tag removes its taggings.\n\n## License\n\nMIT\n","program":{"html_id":"artistry/toplevel","path":"toplevel.html","kind":"module","full_name":"Top Level Namespace","name":"Top Level Namespace","abstract":false,"locations":[],"repository_name":"artistry","program":true,"enum":false,"alias":false,"const":false,"types":[{"html_id":"artistry/Artistry","path":"Artistry.html","kind":"module","full_name":"Artistry","name":"Artistry","abstract":false,"locations":[{"filename":"src/artistry.cr","line_number":10,"url":null},{"filename":"src/artistry/artifact.cr","line_number":4,"url":null},{"filename":"src/artistry/database.cr","line_number":1,"url":null},{"filename":"src/artistry/link.cr","line_number":3,"url":null},{"filename":"src/artistry/registry.cr","line_number":4,"url":null},{"filename":"src/artistry/tag.cr","line_number":1,"url":null},{"filename":"src/artistry/transaction.cr","line_number":1,"url":null},{"filename":"src/artistry/validator.cr","line_number":4,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"constants":[{"id":"VERSION","name":"VERSION","value":"\"0.9.1\""}],"class_methods":[{"html_id":"close:Nil-class-method","name":"close","abstract":false,"location":{"filename":"src/artistry.cr","line_number":52,"url":null},"def":{"name":"close","return_type":"Nil","visibility":"Public","body":"if @@owns_db\n  @@db.try(&.close)\nend\n@@db = nil\n@@owns_db = false\n"},"external_var":false},{"html_id":"conn-class-method","name":"conn","abstract":false,"location":{"filename":"src/artistry.cr","line_number":60,"url":null},"def":{"name":"conn","visibility":"Public","body":"@@tx_connections[Fiber.current]? || db"},"external_var":false},{"html_id":"db:DB::Database-class-method","name":"db","abstract":false,"location":{"filename":"src/artistry.cr","line_number":14,"url":null},"def":{"name":"db","return_type":"DB::Database","visibility":"Public","body":"if (__temp_104 = @@db).nil?\n  ::raise(::NilAssertionError.new(\"Artistry.db cannot be nil\"))\nelse\n  __temp_104\nend"},"external_var":false},{"html_id":"db?:DB::Database|Nil-class-method","name":"db?","abstract":false,"location":{"filename":"src/artistry.cr","line_number":14,"url":null},"def":{"name":"db?","return_type":"DB::Database | ::Nil","visibility":"Public","body":"@@db"},"external_var":false},{"html_id":"db_path:String-class-method","name":"db_path","abstract":false,"location":{"filename":"src/artistry.cr","line_number":13,"url":null},"def":{"name":"db_path","return_type":"String","visibility":"Public","body":"@@db_path"},"external_var":false},{"html_id":"db_path=(db_path:String)-class-method","name":"db_path=","abstract":false,"args":[{"name":"db_path","external_name":"db_path","restriction":"String"}],"args_string":"(db_path : String)","args_html":"(db_path : String)","location":{"filename":"src/artistry.cr","line_number":13,"url":null},"def":{"name":"db_path=","args":[{"name":"db_path","external_name":"db_path","restriction":"String"}],"visibility":"Public","body":"@@db_path = db_path"},"external_var":false},{"html_id":"open(path:String=db_path):DB::Database-class-method","name":"open","doc":"Open a new connection by path (Artistry owns and will close it)","summary":"<p>Open a new connection by path (Artistry owns and will close it)</p>","abstract":false,"args":[{"name":"path","default_value":"db_path","external_name":"path","restriction":"String"}],"args_string":"(path : String = db_path) : DB::Database","args_html":"(path : String = db_path) : DB::Database","location":{"filename":"src/artistry.cr","line_number":18,"url":null},"def":{"name":"open","args":[{"name":"path","default_value":"db_path","external_name":"path","restriction":"String"}],"return_type":"DB::Database","visibility":"Public","body":"if @@db\n  close\nend\nuri = path == \":memory:\" ? \"sqlite3:%3Amemory%3A\" : \"sqlite3://#{path}\"\ndb = DB.open(uri)\ndb.exec(\"PRAGMA foreign_keys = ON\")\n@@db = db\n@@owns_db = true\nDatabase.ensure_schema(db)\ndb\n"},"external_var":false},{"html_id":"open(db:DB::Database):DB::Database-class-method","name":"open","doc":"Use an existing connection (caller owns it, Artistry won't close it)","summary":"<p>Use an existing connection (caller owns it, Artistry won't close it)</p>","abstract":false,"args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"args_string":"(db : DB::Database) : DB::Database","args_html":"(db : DB::Database) : DB::Database","location":{"filename":"src/artistry.cr","line_number":30,"url":null},"def":{"name":"open","args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"return_type":"DB::Database","visibility":"Public","body":"if @@db\n  close\nend\n@@db = db\n@@owns_db = false\nDatabase.ensure_schema(db)\ndb\n"},"external_var":false},{"html_id":"open(path:String=db_path,&):Nil-class-method","name":"open","abstract":false,"args":[{"name":"path","default_value":"db_path","external_name":"path","restriction":"String"}],"args_string":"(path : String = db_path, &) : Nil","args_html":"(path : String = db_path, &) : Nil","location":{"filename":"src/artistry.cr","line_number":38,"url":null},"def":{"name":"open","args":[{"name":"path","default_value":"db_path","external_name":"path","restriction":"String"}],"yields":1,"block_arity":1,"return_type":"Nil","visibility":"Public","body":"begin\n  open(path)\n  yield db\nensure\n  close\nend"},"external_var":false},{"html_id":"open(db:DB::Database,&):Nil-class-method","name":"open","abstract":false,"args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"args_string":"(db : DB::Database, &) : Nil","args_html":"(db : DB::Database, &) : Nil","location":{"filename":"src/artistry.cr","line_number":45,"url":null},"def":{"name":"open","args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"yields":1,"block_arity":1,"return_type":"Nil","visibility":"Public","body":"begin\n  open(db)\n  yield db\nensure\n  close\nend"},"external_var":false},{"html_id":"transaction(&)-class-method","name":"transaction","abstract":false,"location":{"filename":"src/artistry.cr","line_number":64,"url":null},"def":{"name":"transaction","yields":1,"block_arity":1,"visibility":"Public","body":"begin\n  db.using_connection do |conn|\n    @@tx_connections[Fiber.current] = conn\n    conn.transaction do |tx|\n      yield Transaction.new(tx)\n    end\n  end\nensure\n  @@tx_connections.delete(Fiber.current)\nend"},"external_var":false}],"types":[{"html_id":"artistry/Artistry/Artifact","path":"Artistry/Artifact.html","kind":"class","full_name":"Artistry::Artifact","name":"Artifact","abstract":false,"superclass":{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/artifact.cr","line_number":5,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"find(id:Int64):Artifact|Nil-class-method","name":"find","doc":"Find by ID","summary":"<p>Find by ID</p>","abstract":false,"args":[{"name":"id","external_name":"id","restriction":"Int64"}],"args_string":"(id : Int64) : Artifact | Nil","args_html":"(id : Int64) : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Nil","location":{"filename":"src/artistry/artifact.cr","line_number":97,"url":null},"def":{"name":"find","args":[{"name":"id","external_name":"id","restriction":"Int64"}],"return_type":"Artifact | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                a.new_id, a.updated_at\\n         FROM artifact a\\n         JOIN identity i ON a.id = i.id\\n         WHERE a.id = ?\", id, as: {Int64, String, Int32, String, String, Int64, ::Union(Int64, ::Nil), ::Union(Int64, ::Nil)})\nif row\nelse\n  return nil\nend\nfrom_row(row)\n"},"external_var":false},{"html_id":"find(slug:String):Artifact|Nil-class-method","name":"find","doc":"Find by slug (e.g., \"E42\", \"EV123\")","summary":"<p>Find by slug (e.g., &quot;E42&quot;, &quot;EV123&quot;)</p>","abstract":false,"args":[{"name":"slug","external_name":"slug","restriction":"String"}],"args_string":"(slug : String) : Artifact | Nil","args_html":"(slug : String) : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Nil","location":{"filename":"src/artistry/artifact.cr","line_number":112,"url":null},"def":{"name":"find","args":[{"name":"slug","external_name":"slug","restriction":"String"}],"return_type":"Artifact | ::Nil","visibility":"Public","body":"match = slug.match(/^([A-Z]+)(\\d+)$/i)\nif match\nelse\n  return nil\nend\ncode = match[1].upcase\nid = match[2].to_i64?\nif id\nelse\n  return nil\nend\nartifact = find(id)\nif artifact && (artifact.code == code)\nelse\n  return nil\nend\nartifact\n"},"external_var":false},{"html_id":"hash_data(data_json:String):String-class-method","name":"hash_data","abstract":false,"args":[{"name":"data_json","external_name":"data_json","restriction":"String"}],"args_string":"(data_json : String) : String","args_html":"(data_json : String) : String","location":{"filename":"src/artistry/artifact.cr","line_number":19,"url":null},"def":{"name":"hash_data","args":[{"name":"data_json","external_name":"data_json","restriction":"String"}],"return_type":"String","visibility":"Public","body":"Digest::SHA256.hexdigest(data_json)"},"external_var":false},{"html_id":"where(code:String,include_superseded:Bool=false):Array(Artifact)-class-method","name":"where","doc":"Query artifacts by code (current versions only by default)","summary":"<p>Query artifacts by code (current versions only by default)</p>","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"args_string":"(code : String, include_superseded : Bool = false) : Array(Artifact)","args_html":"(code : String, include_superseded : Bool = <span class=\"n\">false</span>) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/artifact.cr","line_number":125,"url":null},"def":{"name":"where","args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"return_type":"Array(Artifact)","visibility":"Public","body":"results = [] of Artifact\nsql = if include_superseded\n  \"SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                      a.new_id, a.updated_at\\n               FROM artifact a\\n               JOIN identity i ON a.id = i.id\\n               WHERE a.code = ?\\n               ORDER BY a.id\"\nelse\n  \"SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                      a.new_id, a.updated_at\\n               FROM artifact a\\n               JOIN identity i ON a.id = i.id\\n               WHERE a.code = ? AND a.new_id IS NULL\\n               ORDER BY a.id\"\nend\n\nArtistry.conn.query(sql, code) do |rs|\n  rs.each do\n    results << (Artifact.new(rs.read(Int64), rs.read(String), rs.read(Int32), JSON.parse(rs.read(String)), rs.read(String), rs.read(Int64), rs.read(::Union(Int64, ::Nil)), rs.read(::Union(Int64, ::Nil))))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"where(code:String,include_superseded:Bool=false,**conditions):Array(Artifact)-class-method","name":"where","doc":"Query with JSON field conditions (current versions only by default)","summary":"<p>Query with JSON field conditions (current versions only by default)</p>","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"args_string":"(code : String, include_superseded : Bool = false, **conditions) : Array(Artifact)","args_html":"(code : String, include_superseded : Bool = <span class=\"n\">false</span>, **conditions) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/artifact.cr","line_number":161,"url":null},"def":{"name":"where","args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"double_splat":{"name":"conditions","external_name":"conditions","restriction":""},"return_type":"Array(Artifact)","visibility":"Public","body":"if conditions.empty?\n  return where(code, include_superseded)\nend\n\nwhere_clauses = [\"a.code = ?\"]\nif include_superseded\nelse\n  where_clauses << \"a.new_id IS NULL\"\nend\nparams = [code] of DB::Any\n\nconditions.each do |key, value|\n  where_clauses << \"json_extract(a.data, '$.#{key}') = ?\"\n  params << value\nend\n\nsql = \"  SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n         a.new_id, a.updated_at\\n  FROM artifact a\\n  JOIN identity i ON a.id = i.id\\n  WHERE #{where_clauses.join(\" AND \")}\\n  ORDER BY a.id\"\n\nresults = [] of Artifact\nArtistry.conn.query(sql, args: params) do |rs|\n  rs.each do\n    results << (Artifact.new(rs.read(Int64), rs.read(String), rs.read(Int32), JSON.parse(rs.read(String)), rs.read(String), rs.read(Int64), rs.read(::Union(Int64, ::Nil)), rs.read(::Union(Int64, ::Nil))))\n  end\nend\nresults\n"},"external_var":false}],"constructors":[{"html_id":"create(plugin:String,kind:String,data):Artifact-class-method","name":"create","doc":"Create via plugin and kind names","summary":"<p>Create via plugin and kind names</p>","abstract":false,"args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"args_string":"(plugin : String, kind : String, data) : Artifact","args_html":"(plugin : String, kind : String, data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/artifact.cr","line_number":64,"url":null},"def":{"name":"create","args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"reg = Registry.find(plugin, kind)\nif reg\nelse\n  raise(\"Unknown artifact: #{plugin}/#{kind}\")\nend\ncreate_with_registry(reg, data)\n"},"external_var":false},{"html_id":"create(kind_or_code:String,data):Artifact-class-method","name":"create","doc":"Create via code or kind name","summary":"<p>Create via code or kind name</p>","abstract":false,"args":[{"name":"kind_or_code","external_name":"kind_or_code","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"args_string":"(kind_or_code : String, data) : Artifact","args_html":"(kind_or_code : String, data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/artifact.cr","line_number":71,"url":null},"def":{"name":"create","args":[{"name":"kind_or_code","external_name":"kind_or_code","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"reg = Registry.find(kind_or_code.upcase)\nif reg\nelse\n  reg = Registry.find_by_kind(kind_or_code)\nend\nif reg\nelse\n  raise(\"Unknown artifact kind: #{kind_or_code}\")\nend\ncreate_with_registry(reg, data)\n"},"external_var":false},{"html_id":"new(id:Int64,code:String,version:Int32,data:JSON::Any,hash:String,created_at:Int64,new_id:Int64|Nil=nil,updated_at:Int64|Nil=nil)-class-method","name":"new","abstract":false,"args":[{"name":"id","external_name":"id","restriction":"::Int64"},{"name":"code","external_name":"code","restriction":"::String"},{"name":"version","external_name":"version","restriction":"::Int32"},{"name":"data","external_name":"data","restriction":"::JSON::Any"},{"name":"hash","external_name":"hash","restriction":"::String"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"},{"name":"new_id","default_value":"nil","external_name":"new_id","restriction":"::Int64 | ::Nil"},{"name":"updated_at","default_value":"nil","external_name":"updated_at","restriction":"::Int64 | ::Nil"}],"args_string":"(id : Int64, code : String, version : Int32, data : JSON::Any, hash : String, created_at : Int64, new_id : Int64 | Nil = nil, updated_at : Int64 | Nil = nil)","args_html":"(id : Int64, code : String, version : Int32, data : JSON::Any, hash : String, created_at : Int64, new_id : Int64 | Nil = <span class=\"n\">nil</span>, updated_at : Int64 | Nil = <span class=\"n\">nil</span>)","location":{"filename":"src/artistry/artifact.cr","line_number":15,"url":null},"def":{"name":"new","args":[{"name":"id","external_name":"id","restriction":"::Int64"},{"name":"code","external_name":"code","restriction":"::String"},{"name":"version","external_name":"version","restriction":"::Int32"},{"name":"data","external_name":"data","restriction":"::JSON::Any"},{"name":"hash","external_name":"hash","restriction":"::String"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"},{"name":"new_id","default_value":"nil","external_name":"new_id","restriction":"::Int64 | ::Nil"},{"name":"updated_at","default_value":"nil","external_name":"updated_at","restriction":"::Int64 | ::Nil"}],"visibility":"Public","body":"_ = allocate\n_.initialize(id, code, version, data, hash, created_at, new_id, updated_at)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"[](key:String):JSON::Any-instance-method","name":"[]","doc":"Access data fields","summary":"<p>Access data fields</p>","abstract":false,"args":[{"name":"key","external_name":"key","restriction":"String"}],"args_string":"(key : String) : JSON::Any","args_html":"(key : String) : JSON::Any","location":{"filename":"src/artistry/artifact.cr","line_number":263,"url":null},"def":{"name":"[]","args":[{"name":"key","external_name":"key","restriction":"String"}],"return_type":"JSON::Any","visibility":"Public","body":"data[key]"},"external_var":false},{"html_id":"[]?(key:String):JSON::Any|Nil-instance-method","name":"[]?","abstract":false,"args":[{"name":"key","external_name":"key","restriction":"String"}],"args_string":"(key : String) : JSON::Any | Nil","args_html":"(key : String) : JSON::Any | Nil","location":{"filename":"src/artistry/artifact.cr","line_number":267,"url":null},"def":{"name":"[]?","args":[{"name":"key","external_name":"key","restriction":"String"}],"return_type":"JSON::Any | ::Nil","visibility":"Public","body":"data[key]?"},"external_var":false},{"html_id":"code:String-instance-method","name":"code","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":7,"url":null},"def":{"name":"code","return_type":"String","visibility":"Public","body":"@code"},"external_var":false},{"html_id":"created_at:Int64-instance-method","name":"created_at","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":11,"url":null},"def":{"name":"created_at","return_type":"Int64","visibility":"Public","body":"@created_at"},"external_var":false},{"html_id":"current?:Bool-instance-method","name":"current?","doc":"Is this the current (non-superseded) version?","summary":"<p>Is this the current (non-superseded) version?</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":206,"url":null},"def":{"name":"current?","return_type":"Bool","visibility":"Public","body":"new_id.nil?"},"external_var":false},{"html_id":"data:JSON::Any-instance-method","name":"data","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":9,"url":null},"def":{"name":"data","return_type":"JSON::Any","visibility":"Public","body":"@data"},"external_var":false},{"html_id":"delete:Nil-instance-method","name":"delete","doc":"Delete artifact (hard delete)","summary":"<p>Delete artifact (hard delete)</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":363,"url":null},"def":{"name":"delete","return_type":"Nil","visibility":"Public","body":"db = Artistry.conn\ndb.exec(\"DELETE FROM artifact WHERE id = ?\", id)\ndb.exec(\"DELETE FROM identity WHERE id = ?\", id)\n"},"external_var":false},{"html_id":"hash:String-instance-method","name":"hash","doc":"Generates an `UInt64` hash value for this object.\n\nThis method must have the property that `a == b` implies `a.hash == b.hash`.\n\nThe hash value is used along with `==` by the `Hash` class to determine if two objects\nreference the same hash key.\n\nSubclasses must not override this method. Instead, they must define `hash(hasher)`,\nthough usually the macro `def_hash` can be used to generate this method.","summary":"<p>Generates an <code>UInt64</code> hash value for this object.</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":10,"url":null},"def":{"name":"hash","return_type":"String","visibility":"Public","body":"@hash"},"external_var":false},{"html_id":"history:Array(Artifact)-instance-method","name":"history","doc":"Get the full history chain (oldest first)","summary":"<p>Get the full history chain (oldest first)</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":234,"url":null},"def":{"name":"history","return_type":"Array(Artifact)","visibility":"Public","body":"root = self\nloop do\n\n  prev = Artistry.conn.query_one?(\"SELECT id FROM artifact WHERE new_id = ?\", root.id, as: Int64)\n  if prev\n  else\n    break\n  end\n  prev_artifact = Artifact.find(prev)\n  if prev_artifact\n  else\n    break\n  end\n  root = prev_artifact\nend\n\n\nchain = [root]\ncurrent = root\nwhile current.superseded?\n  next_version = current.successor\n  if next_version\n  else\n    break\n  end\n  chain << next_version\n  current = next_version\nend\nchain\n"},"external_var":false},{"html_id":"id:Int64-instance-method","name":"id","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":6,"url":null},"def":{"name":"id","return_type":"Int64","visibility":"Public","body":"@id"},"external_var":false},{"html_id":"latest:Artifact-instance-method","name":"latest","doc":"Get the latest version in this artifact's chain","summary":"<p>Get the latest version in this artifact's chain</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":223,"url":null},"def":{"name":"latest","return_type":"Artifact","visibility":"Public","body":"current = self\nwhile current.superseded?\n  next_version = current.successor\n  if next_version\n  else\n    break\n  end\n  current = next_version\nend\ncurrent\n"},"external_var":false},{"html_id":"new_id:Int64|Nil-instance-method","name":"new_id","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":12,"url":null},"def":{"name":"new_id","return_type":"Int64 | ::Nil","visibility":"Public","body":"@new_id"},"external_var":false},{"html_id":"slug:String-instance-method","name":"slug","doc":"Slug representation (e.g., \"E1\", \"EV42\")","summary":"<p>Slug representation (e.g., &quot;E1&quot;, &quot;EV42&quot;)</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":201,"url":null},"def":{"name":"slug","return_type":"String","visibility":"Public","body":"\"#{code}#{id}\""},"external_var":false},{"html_id":"successor:Artifact|Nil-instance-method","name":"successor","doc":"Get the artifact that superseded this one","summary":"<p>Get the artifact that superseded this one</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":216,"url":null},"def":{"name":"successor","return_type":"Artifact | ::Nil","visibility":"Public","body":"sid = new_id\nif sid\nelse\n  return nil\nend\nArtifact.find(sid)\n"},"external_var":false},{"html_id":"superseded?:Bool-instance-method","name":"superseded?","doc":"Has this been superseded by a newer version?","summary":"<p>Has this been superseded by a newer version?</p>","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":211,"url":null},"def":{"name":"superseded?","return_type":"Bool","visibility":"Public","body":"!new_id.nil?"},"external_var":false},{"html_id":"update(new_data):Artifact-instance-method","name":"update","doc":"COW update - creates new version, supersedes this one","summary":"<p>COW update - creates new version, supersedes this one</p>","abstract":false,"args":[{"name":"new_data","external_name":"new_data","restriction":""}],"args_string":"(new_data) : Artifact","args_html":"(new_data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/artifact.cr","line_number":272,"url":null},"def":{"name":"update","args":[{"name":"new_data","external_name":"new_data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"if superseded?\n  raise(\"Cannot update superseded artifact (use .latest.update)\")\nend\n\ndb = Artistry.conn\n\n\ncurrent_version = db.query_one?(\"SELECT version FROM registry WHERE code = ?\", code, as: Int32)\nif current_version\nelse\n  raise(\"Unknown artifact code: #{code}\")\nend\n\n\nnew_json = (JSON.parse(new_data.to_json)).as_h\nmerged = data.as_h.merge(new_json)\nmerged_parsed = JSON.parse(merged.to_json)\n\n\nschema = Registry.get_schema(code, current_version)\nif schema\n  merged_parsed = Validator.apply_defaults(merged_parsed, schema)\n  Validator.validate(merged_parsed, schema)\nend\n\ndata_json = merged_parsed.to_json\ndata_hash = Artifact.hash_data(data_json)\n\n\ndb.exec(\"INSERT INTO identity DEFAULT VALUES\")\nnew_id = (db.scalar(\"SELECT last_insert_rowid()\")).as(Int64)\n\n\ndb.exec(\"INSERT INTO artifact (id, code, version, data, hash) VALUES (?, ?, ?, ?, ?)\", new_id, code, current_version, data_json, data_hash)\n\n\ndb.exec(\"UPDATE artifact SET new_id = ? WHERE id = ?\", new_id, id)\n\nnew_created_at = db.query_one(\"SELECT created_at FROM identity WHERE id = ?\", new_id, as: Int64)\n\nArtifact.new(new_id, code, current_version, merged_parsed, data_hash, new_created_at)\n"},"external_var":false},{"html_id":"update!(new_data):Artifact-instance-method","name":"update!","doc":"Mutable update - modifies in place, sets updated_at","summary":"<p>Mutable update - modifies in place, sets updated_at</p>","abstract":false,"args":[{"name":"new_data","external_name":"new_data","restriction":""}],"args_string":"(new_data) : Artifact","args_html":"(new_data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/artifact.cr","line_number":326,"url":null},"def":{"name":"update!","args":[{"name":"new_data","external_name":"new_data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"db = Artistry.conn\n\n\ncurrent_version = db.query_one?(\"SELECT version FROM registry WHERE code = ?\", code, as: Int32)\nif current_version\nelse\n  raise(\"Unknown artifact code: #{code}\")\nend\n\n\nnew_json = (JSON.parse(new_data.to_json)).as_h\nmerged = data.as_h.merge(new_json)\nmerged_parsed = JSON.parse(merged.to_json)\n\n\nschema = Registry.get_schema(code, current_version)\nif schema\n  merged_parsed = Validator.apply_defaults(merged_parsed, schema)\n  Validator.validate(merged_parsed, schema)\nend\n\ndata_json = merged_parsed.to_json\ndata_hash = Artifact.hash_data(data_json)\nnow = Artifact.now_ms\n\ndb.exec(\"UPDATE artifact SET data = ?, version = ?, hash = ?, updated_at = ? WHERE id = ?\", data_json, current_version, data_hash, now, id)\n\nArtifact.new(id, code, current_version, merged_parsed, data_hash, created_at, new_id, now)\n"},"external_var":false},{"html_id":"updated_at:Int64|Nil-instance-method","name":"updated_at","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":13,"url":null},"def":{"name":"updated_at","return_type":"Int64 | ::Nil","visibility":"Public","body":"@updated_at"},"external_var":false},{"html_id":"version:Int32-instance-method","name":"version","abstract":false,"location":{"filename":"src/artistry/artifact.cr","line_number":8,"url":null},"def":{"name":"version","return_type":"Int32","visibility":"Public","body":"@version"},"external_var":false}]},{"html_id":"artistry/Artistry/Database","path":"Artistry/Database.html","kind":"module","full_name":"Artistry::Database","name":"Database","abstract":false,"locations":[{"filename":"src/artistry/database.cr","line_number":2,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"constants":[{"id":"SCHEMA","name":"SCHEMA","value":"\"  CREATE TABLE IF NOT EXISTS identity (\\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\\n    created_at INTEGER NOT NULL DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer))\\n  );\\n\\n  CREATE TABLE IF NOT EXISTS registry (\\n    code TEXT PRIMARY KEY,\\n    kind TEXT NOT NULL,\\n    plugin TEXT NOT NULL,\\n    description TEXT,\\n    symbol TEXT,\\n    version INTEGER NOT NULL DEFAULT 1,\\n    UNIQUE(plugin, kind)\\n  );\\n\\n  CREATE TABLE IF NOT EXISTS schema (\\n    code TEXT NOT NULL,\\n    version INTEGER NOT NULL,\\n    json TEXT NOT NULL,\\n    hash TEXT NOT NULL,\\n    created_at INTEGER NOT NULL DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer)),\\n    PRIMARY KEY (code, version),\\n    FOREIGN KEY (code) REFERENCES registry(code)\\n  );\\n\\n  CREATE TABLE IF NOT EXISTS artifact (\\n    id INTEGER PRIMARY KEY,\\n    code TEXT NOT NULL,\\n    version INTEGER NOT NULL,\\n    data JSON NOT NULL,\\n    hash TEXT NOT NULL,\\n    new_id INTEGER REFERENCES identity(id),\\n    updated_at INTEGER,\\n    FOREIGN KEY (id) REFERENCES identity(id),\\n    FOREIGN KEY (code, version) REFERENCES schema(code, version)\\n  );\\n\\n  CREATE INDEX IF NOT EXISTS idx_artifact_code ON artifact(code);\\n  CREATE INDEX IF NOT EXISTS idx_artifact_new_id ON artifact(new_id);\\n\\n  CREATE TABLE IF NOT EXISTS link (\\n    from_id INTEGER NOT NULL REFERENCES identity(id) ON DELETE CASCADE,\\n    to_id INTEGER NOT NULL REFERENCES identity(id) ON DELETE CASCADE,\\n    rel TEXT NOT NULL,\\n    data JSON,\\n    created_at INTEGER NOT NULL DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer)),\\n    PRIMARY KEY (from_id, to_id, rel)\\n  );\\n\\n  CREATE TABLE IF NOT EXISTS tag (\\n    id INTEGER PRIMARY KEY AUTOINCREMENT,\\n    name TEXT NOT NULL UNIQUE,\\n    created_at INTEGER NOT NULL DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer))\\n  );\\n\\n  CREATE TABLE IF NOT EXISTS tagging (\\n    tag_id INTEGER NOT NULL REFERENCES tag(id) ON DELETE CASCADE,\\n    artifact_id INTEGER NOT NULL REFERENCES identity(id) ON DELETE CASCADE,\\n    created_at INTEGER NOT NULL DEFAULT (cast((julianday('now') - 2440587.5) * 86400000 as integer)),\\n    PRIMARY KEY (tag_id, artifact_id)\\n  );\\n\\n  CREATE INDEX IF NOT EXISTS idx_tagging_artifact_id ON tagging(artifact_id);\""}],"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"ensure_schema(db:DB::Database):Nil-class-method","name":"ensure_schema","abstract":false,"args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"args_string":"(db : DB::Database) : Nil","args_html":"(db : DB::Database) : Nil","location":{"filename":"src/artistry/database.cr","line_number":69,"url":null},"def":{"name":"ensure_schema","args":[{"name":"db","external_name":"db","restriction":"DB::Database"}],"return_type":"Nil","visibility":"Public","body":"(SCHEMA.split(\";\")).each do |stmt|\n  stmt = stmt.strip\n  if stmt.empty?\n    next\n  end\n  db.exec(stmt)\nend"},"external_var":false}]},{"html_id":"artistry/Artistry/Link","path":"Artistry/Link.html","kind":"class","full_name":"Artistry::Link","name":"Link","abstract":false,"superclass":{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/link.cr","line_number":4,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"delete_from(artifact:Artifact|Int64,rel:String):Nil-class-method","name":"delete_from","doc":"Delete all links of a rel from an artifact","summary":"<p>Delete all links of a rel from an artifact</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, rel : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String) : Nil","location":{"filename":"src/artistry/link.cr","line_number":132,"url":null},"def":{"name":"delete_from","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"id = artifact.is_a?(Artifact) ? artifact.id : artifact\nArtistry.conn.exec(\"DELETE FROM link WHERE from_id = ? AND rel = ?\", id, rel)\n"},"external_var":false},{"html_id":"delete_to(artifact:Artifact|Int64,rel:String):Nil-class-method","name":"delete_to","doc":"Delete all links of a rel to an artifact","summary":"<p>Delete all links of a rel to an artifact</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, rel : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String) : Nil","location":{"filename":"src/artistry/link.cr","line_number":141,"url":null},"def":{"name":"delete_to","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"id = artifact.is_a?(Artifact) ? artifact.id : artifact\nArtistry.conn.exec(\"DELETE FROM link WHERE to_id = ? AND rel = ?\", id, rel)\n"},"external_var":false},{"html_id":"find(from_id:Int64,to_id:Int64,rel:String):Link|Nil-class-method","name":"find","doc":"Find a specific link","summary":"<p>Find a specific link</p>","abstract":false,"args":[{"name":"from_id","external_name":"from_id","restriction":"Int64"},{"name":"to_id","external_name":"to_id","restriction":"Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"args_string":"(from_id : Int64, to_id : Int64, rel : String) : Link | Nil","args_html":"(from_id : Int64, to_id : Int64, rel : String) : <a href=\"../Artistry/Link.html\">Link</a> | Nil","location":{"filename":"src/artistry/link.cr","line_number":45,"url":null},"def":{"name":"find","args":[{"name":"from_id","external_name":"from_id","restriction":"Int64"},{"name":"to_id","external_name":"to_id","restriction":"Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"return_type":"Link | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT from_id, to_id, rel, data, created_at FROM link\\n         WHERE from_id = ? AND to_id = ? AND rel = ?\", from_id, to_id, rel, as: {Int64, Int64, String, ::Union(String, ::Nil), Int64})\nif row\nelse\n  return nil\nend\ndata_str = row[3]\nLink.new(row[0], row[1], row[2], data_str ? JSON.parse(data_str) : nil, row[4])\n"},"external_var":false},{"html_id":"from(artifact:Artifact|Int64,rel:String|Nil=nil):Array(Link)-class-method","name":"from","doc":"Get all outgoing links from an artifact","summary":"<p>Get all outgoing links from an artifact</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"args_string":"(artifact : Artifact | Int64, rel : String | Nil = nil) : Array(Link)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String | Nil = <span class=\"n\">nil</span>) : Array(<a href=\"../Artistry/Link.html\">Link</a>)","location":{"filename":"src/artistry/link.cr","line_number":58,"url":null},"def":{"name":"from","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"return_type":"Array(Link)","visibility":"Public","body":"id = artifact.is_a?(Artifact) ? artifact.id : artifact\nresults = [] of Link\n\nsql = if rel\n  \"SELECT from_id, to_id, rel, data, created_at FROM link\\n               WHERE from_id = ? AND rel = ? ORDER BY created_at\"\nelse\n  \"SELECT from_id, to_id, rel, data, created_at FROM link\\n               WHERE from_id = ? ORDER BY rel, created_at\"\nend\n\nargs = rel ? [id, rel] : [id]\n\nArtistry.conn.query(sql, args: args.map() do |__arg0| __arg0.as(DB::Any) end) do |rs|\n  rs.each do\n    from = rs.read(Int64)\n    to = rs.read(Int64)\n    r = rs.read(String)\n    data_str = rs.read(::Union(String, ::Nil))\n    created = rs.read(Int64)\n    results << (Link.new(from, to, r, data_str ? JSON.parse(data_str) : nil, created))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"to(artifact:Artifact|Int64,rel:String|Nil=nil):Array(Link)-class-method","name":"to","doc":"Get all incoming links to an artifact","summary":"<p>Get all incoming links to an artifact</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"args_string":"(artifact : Artifact | Int64, rel : String | Nil = nil) : Array(Link)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String | Nil = <span class=\"n\">nil</span>) : Array(<a href=\"../Artistry/Link.html\">Link</a>)","location":{"filename":"src/artistry/link.cr","line_number":86,"url":null},"def":{"name":"to","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"return_type":"Array(Link)","visibility":"Public","body":"id = artifact.is_a?(Artifact) ? artifact.id : artifact\nresults = [] of Link\n\nsql = if rel\n  \"SELECT from_id, to_id, rel, data, created_at FROM link\\n               WHERE to_id = ? AND rel = ? ORDER BY created_at\"\nelse\n  \"SELECT from_id, to_id, rel, data, created_at FROM link\\n               WHERE to_id = ? ORDER BY rel, created_at\"\nend\n\nargs = rel ? [id, rel] : [id]\n\nArtistry.conn.query(sql, args: args.map() do |__arg1| __arg1.as(DB::Any) end) do |rs|\n  rs.each do\n    from = rs.read(Int64)\n    to = rs.read(Int64)\n    r = rs.read(String)\n    data_str = rs.read(::Union(String, ::Nil))\n    created = rs.read(Int64)\n    results << (Link.new(from, to, r, data_str ? JSON.parse(data_str) : nil, created))\n  end\nend\nresults\n"},"external_var":false}],"constructors":[{"html_id":"create(from:Artifact|Int64,to:Artifact|Int64,rel:String,data=nil):Link-class-method","name":"create","doc":"Create a link between two artifacts","summary":"<p>Create a link between two artifacts</p>","abstract":false,"args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"args_string":"(from : Artifact | Int64, to : Artifact | Int64, rel : String, data = nil) : Link","args_html":"(from : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, to : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String, data = <span class=\"n\">nil</span>) : <a href=\"../Artistry/Link.html\">Link</a>","location":{"filename":"src/artistry/link.cr","line_number":15,"url":null},"def":{"name":"create","args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"return_type":"Link","visibility":"Public","body":"from_id = from.is_a?(Artifact) ? from.id : from\nto_id = to.is_a?(Artifact) ? to.id : to\n\ndata_json = data ? data.to_json : nil\n\nArtistry.conn.exec(\"INSERT INTO link (from_id, to_id, rel, data) VALUES (?, ?, ?, ?)\", from_id, to_id, rel, data_json)\n\ncreated_at = Artistry.conn.query_one(\"SELECT created_at FROM link WHERE from_id = ? AND to_id = ? AND rel = ?\", from_id, to_id, rel, as: Int64)\n\nLink.new(from_id, to_id, rel, data_json ? JSON.parse(data_json) : nil, created_at)\n"},"external_var":false},{"html_id":"create(from_slug:String,to_slug:String,rel:String,data=nil):Link-class-method","name":"create","doc":"Create from slug strings","summary":"<p>Create from slug strings</p>","abstract":false,"args":[{"name":"from_slug","external_name":"from_slug","restriction":"String"},{"name":"to_slug","external_name":"to_slug","restriction":"String"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"args_string":"(from_slug : String, to_slug : String, rel : String, data = nil) : Link","args_html":"(from_slug : String, to_slug : String, rel : String, data = <span class=\"n\">nil</span>) : <a href=\"../Artistry/Link.html\">Link</a>","location":{"filename":"src/artistry/link.cr","line_number":36,"url":null},"def":{"name":"create","args":[{"name":"from_slug","external_name":"from_slug","restriction":"String"},{"name":"to_slug","external_name":"to_slug","restriction":"String"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"return_type":"Link","visibility":"Public","body":"from = Artifact.find(from_slug)\nto = Artifact.find(to_slug)\nif from\nelse\n  raise(\"Invalid from slug: #{from_slug}\")\nend\nif to\nelse\n  raise(\"Invalid to slug: #{to_slug}\")\nend\ncreate(from, to, rel, data)\n"},"external_var":false},{"html_id":"new(from_id:Int64,to_id:Int64,rel:String,data:JSON::Any|Nil,created_at:Int64)-class-method","name":"new","abstract":false,"args":[{"name":"from_id","external_name":"from_id","restriction":"::Int64"},{"name":"to_id","external_name":"to_id","restriction":"::Int64"},{"name":"rel","external_name":"rel","restriction":"::String"},{"name":"data","external_name":"data","restriction":"::JSON::Any | ::Nil"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"}],"args_string":"(from_id : Int64, to_id : Int64, rel : String, data : JSON::Any | Nil, created_at : Int64)","args_html":"(from_id : Int64, to_id : Int64, rel : String, data : JSON::Any | Nil, created_at : Int64)","location":{"filename":"src/artistry/link.cr","line_number":11,"url":null},"def":{"name":"new","args":[{"name":"from_id","external_name":"from_id","restriction":"::Int64"},{"name":"to_id","external_name":"to_id","restriction":"::Int64"},{"name":"rel","external_name":"rel","restriction":"::String"},{"name":"data","external_name":"data","restriction":"::JSON::Any | ::Nil"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"}],"visibility":"Public","body":"_ = allocate\n_.initialize(from_id, to_id, rel, data, created_at)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"created_at:Int64-instance-method","name":"created_at","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":9,"url":null},"def":{"name":"created_at","return_type":"Int64","visibility":"Public","body":"@created_at"},"external_var":false},{"html_id":"data:JSON::Any|Nil-instance-method","name":"data","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":8,"url":null},"def":{"name":"data","return_type":"JSON::Any | ::Nil","visibility":"Public","body":"@data"},"external_var":false},{"html_id":"delete:Nil-instance-method","name":"delete","doc":"Delete this link","summary":"<p>Delete this link</p>","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":124,"url":null},"def":{"name":"delete","return_type":"Nil","visibility":"Public","body":"Artistry.conn.exec(\"DELETE FROM link WHERE from_id = ? AND to_id = ? AND rel = ?\", from_id, to_id, rel)"},"external_var":false},{"html_id":"from:Artifact|Nil-instance-method","name":"from","doc":"Get the source artifact","summary":"<p>Get the source artifact</p>","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":114,"url":null},"def":{"name":"from","return_type":"Artifact | ::Nil","visibility":"Public","body":"Artifact.find(from_id)"},"external_var":false},{"html_id":"from_id:Int64-instance-method","name":"from_id","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":5,"url":null},"def":{"name":"from_id","return_type":"Int64","visibility":"Public","body":"@from_id"},"external_var":false},{"html_id":"rel:String-instance-method","name":"rel","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":7,"url":null},"def":{"name":"rel","return_type":"String","visibility":"Public","body":"@rel"},"external_var":false},{"html_id":"to:Artifact|Nil-instance-method","name":"to","doc":"Get the target artifact","summary":"<p>Get the target artifact</p>","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":119,"url":null},"def":{"name":"to","return_type":"Artifact | ::Nil","visibility":"Public","body":"Artifact.find(to_id)"},"external_var":false},{"html_id":"to_id:Int64-instance-method","name":"to_id","abstract":false,"location":{"filename":"src/artistry/link.cr","line_number":6,"url":null},"def":{"name":"to_id","return_type":"Int64","visibility":"Public","body":"@to_id"},"external_var":false}]},{"html_id":"artistry/Artistry/Registry","path":"Artistry/Registry.html","kind":"class","full_name":"Artistry::Registry","name":"Registry","abstract":false,"superclass":{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/registry.cr","line_number":5,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"all:Array(Registry)-class-method","name":"all","doc":"List all registrations","summary":"<p>List all registrations</p>","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":182,"url":null},"def":{"name":"all","return_type":"Array(Registry)","visibility":"Public","body":"results = [] of Registry\nArtistry.conn.query(\"SELECT code, kind, plugin, description, symbol, version FROM registry ORDER BY code\") do |rs|\n  rs.each do\n    results << (Registry.new(rs.read(String), rs.read(String), rs.read(String), rs.read(::Union(String, ::Nil)), rs.read(::Union(String, ::Nil)), rs.read(Int32)))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"allocate_code(db,kind:String):String-class-method","name":"allocate_code","doc":"Find the shortest unique prefix for a kind name","summary":"<p>Find the shortest unique prefix for a kind name</p>","abstract":false,"args":[{"name":"db","external_name":"db","restriction":""},{"name":"kind","external_name":"kind","restriction":"String"}],"args_string":"(db, kind : String) : String","args_html":"(db, kind : String) : String","location":{"filename":"src/artistry/registry.cr","line_number":103,"url":null},"def":{"name":"allocate_code","args":[{"name":"db","external_name":"db","restriction":""},{"name":"kind","external_name":"kind","restriction":"String"}],"return_type":"String","visibility":"Public","body":"kind_upper = kind.upcase\n\n(1..kind_upper.size).each do |len|\n  candidate = kind_upper[0, len]\n  exists = db.query_one?(\"SELECT 1 FROM registry WHERE code = ?\", candidate, as: Int32)\n  if exists\n  else\n    return candidate\n  end\nend\n\n\nsuffix = 1\nloop do\n  candidate = \"#{kind_upper}#{suffix}\"\n  exists = db.query_one?(\"SELECT 1 FROM registry WHERE code = ?\", candidate, as: Int32)\n  if exists\n  else\n    return candidate\n  end\n  suffix = suffix + 1\nend\n"},"external_var":false},{"html_id":"find(plugin:String,kind:String):Registry|Nil-class-method","name":"find","doc":"Lookup a registration by plugin and kind","summary":"<p>Lookup a registration by plugin and kind</p>","abstract":false,"args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"}],"args_string":"(plugin : String, kind : String) : Registry | Nil","args_html":"(plugin : String, kind : String) : <a href=\"../Artistry/Registry.html\">Registry</a> | Nil","location":{"filename":"src/artistry/registry.cr","line_number":150,"url":null},"def":{"name":"find","args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"}],"return_type":"Registry | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT code, kind, plugin, description, symbol, version FROM registry WHERE plugin = ? AND kind = ?\", plugin.downcase, kind.downcase, as: {String, String, String, ::Union(String, ::Nil), ::Union(String, ::Nil), Int32})\nif row\nelse\n  return nil\nend\nRegistry.new(*row)\n"},"external_var":false},{"html_id":"find(code:String):Registry|Nil-class-method","name":"find","doc":"Lookup a registration by code","summary":"<p>Lookup a registration by code</p>","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"}],"args_string":"(code : String) : Registry | Nil","args_html":"(code : String) : <a href=\"../Artistry/Registry.html\">Registry</a> | Nil","location":{"filename":"src/artistry/registry.cr","line_number":139,"url":null},"def":{"name":"find","args":[{"name":"code","external_name":"code","restriction":"String"}],"return_type":"Registry | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT code, kind, plugin, description, symbol, version FROM registry WHERE code = ?\", code, as: {String, String, String, ::Union(String, ::Nil), ::Union(String, ::Nil), Int32})\nif row\nelse\n  return nil\nend\nRegistry.new(*row)\n"},"external_var":false},{"html_id":"find_by_kind(kind:String):Registry|Nil-class-method","name":"find_by_kind","doc":"Lookup a registration by kind name only (returns first match if multiple plugins use same kind)","summary":"<p>Lookup a registration by kind name only (returns first match if multiple plugins use same kind)</p>","abstract":false,"args":[{"name":"kind","external_name":"kind","restriction":"String"}],"args_string":"(kind : String) : Registry | Nil","args_html":"(kind : String) : <a href=\"../Artistry/Registry.html\">Registry</a> | Nil","location":{"filename":"src/artistry/registry.cr","line_number":161,"url":null},"def":{"name":"find_by_kind","args":[{"name":"kind","external_name":"kind","restriction":"String"}],"return_type":"Registry | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT code, kind, plugin, description, symbol, version FROM registry WHERE kind = ? LIMIT 1\", kind.downcase, as: {String, String, String, ::Union(String, ::Nil), ::Union(String, ::Nil), Int32})\nif row\nelse\n  return nil\nend\nRegistry.new(*row)\n"},"external_var":false},{"html_id":"get_schema(code:String,version:Int32):JSON::Any|Nil-class-method","name":"get_schema","doc":"Get the schema JSON for a code and version","summary":"<p>Get the schema JSON for a code and version</p>","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"version","external_name":"version","restriction":"Int32"}],"args_string":"(code : String, version : Int32) : JSON::Any | Nil","args_html":"(code : String, version : Int32) : JSON::Any | Nil","location":{"filename":"src/artistry/registry.cr","line_number":172,"url":null},"def":{"name":"get_schema","args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"version","external_name":"version","restriction":"Int32"}],"return_type":"JSON::Any | ::Nil","visibility":"Public","body":"json = Artistry.conn.query_one?(\"SELECT json FROM schema WHERE code = ? AND version = ?\", code, version, as: String)\njson ? JSON.parse(json) : nil\n"},"external_var":false},{"html_id":"hash_schema(json:String):String-class-method","name":"hash_schema","abstract":false,"args":[{"name":"json","external_name":"json","restriction":"String"}],"args_string":"(json : String) : String","args_html":"(json : String) : String","location":{"filename":"src/artistry/registry.cr","line_number":134,"url":null},"def":{"name":"hash_schema","args":[{"name":"json","external_name":"json","restriction":"String"}],"return_type":"String","visibility":"Public","body":"Digest::SHA256.hexdigest(json)"},"external_var":false},{"html_id":"normalize_schema(schema):String-class-method","name":"normalize_schema","abstract":false,"args":[{"name":"schema","external_name":"schema","restriction":""}],"args_string":"(schema) : String","args_html":"(schema) : String","location":{"filename":"src/artistry/registry.cr","line_number":130,"url":null},"def":{"name":"normalize_schema","args":[{"name":"schema","external_name":"schema","restriction":""}],"return_type":"String","visibility":"Public","body":"schema.to_json"},"external_var":false},{"html_id":"register(kind:String,plugin:String,schema,description:String|Nil=nil,symbol:String|Nil=nil,index:Array(String)=[]ofString):String-class-method","name":"register","doc":"Register a new artifact kind. Returns the assigned code.\nSchema can be any JSON-serializable value.\nIndex is a list of field names to create expression indexes on.","summary":"<p>Register a new artifact kind.</p>","abstract":false,"args":[{"name":"kind","external_name":"kind","restriction":"String"},{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"schema","external_name":"schema","restriction":""},{"name":"description","default_value":"nil","external_name":"description","restriction":"String | ::Nil"},{"name":"symbol","default_value":"nil","external_name":"symbol","restriction":"String | ::Nil"},{"name":"index","default_value":"[] of String","external_name":"index","restriction":"Array(String)"}],"args_string":"(kind : String, plugin : String, schema, description : String | Nil = nil, symbol : String | Nil = nil, index : Array(String) = [] of String) : String","args_html":"(kind : String, plugin : String, schema, description : String | Nil = <span class=\"n\">nil</span>, symbol : String | Nil = <span class=\"n\">nil</span>, index : Array(String) = <span class=\"o\">[]</span> <span class=\"k\">of</span> <span class=\"t\">String</span>) : String","location":{"filename":"src/artistry/registry.cr","line_number":19,"url":null},"def":{"name":"register","args":[{"name":"kind","external_name":"kind","restriction":"String"},{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"schema","external_name":"schema","restriction":""},{"name":"description","default_value":"nil","external_name":"description","restriction":"String | ::Nil"},{"name":"symbol","default_value":"nil","external_name":"symbol","restriction":"String | ::Nil"},{"name":"index","default_value":"[] of String","external_name":"index","restriction":"Array(String)"}],"return_type":"String","visibility":"Public","body":"db = Artistry.conn\nkind = kind.downcase\nplugin = plugin.downcase\n\n\nexisting = db.query_one?(\"SELECT code, version FROM registry WHERE plugin = ? AND kind = ?\", plugin, kind, as: {String, Int32})\n\nif existing\n  code, current_version = existing\n\n  schema_json = normalize_schema(schema)\n  schema_hash = hash_schema(schema_json)\n\n  last_hash = db.query_one?(\"SELECT hash FROM schema WHERE code = ? AND version = ?\", code, current_version, as: String)\n\n  if last_hash != schema_hash\n    new_version = current_version + 1\n    db.exec(\"UPDATE registry SET version = ? WHERE code = ?\", new_version, code)\n    db.exec(\"INSERT INTO schema (code, version, json, hash) VALUES (?, ?, ?, ?)\", code, new_version, schema_json, schema_hash)\n  end\n\n\n  create_indexes(db, plugin, kind, code, index)\n\n  return code\nend\n\n\ncode = allocate_code(db, kind)\n\ndb.exec(\"INSERT INTO registry (code, kind, plugin, description, symbol, version) VALUES (?, ?, ?, ?, ?, 1)\", code, kind, plugin, description, symbol)\n\nschema_json = normalize_schema(schema)\nschema_hash = hash_schema(schema_json)\n\ndb.exec(\"INSERT INTO schema (code, version, json, hash) VALUES (?, 1, ?, ?)\", code, schema_json, schema_hash)\n\n\ncreate_indexes(db, plugin, kind, code, index)\n\ncode\n"},"external_var":false}],"constructors":[{"html_id":"new(code:String,kind:String,plugin:String,description:Nil|String,symbol:Nil|String,version:Int32)-class-method","name":"new","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"::String"},{"name":"kind","external_name":"kind","restriction":"::String"},{"name":"plugin","external_name":"plugin","restriction":"::String"},{"name":"description","external_name":"description","restriction":"::Nil | ::String"},{"name":"symbol","external_name":"symbol","restriction":"::Nil | ::String"},{"name":"version","external_name":"version","restriction":"::Int32"}],"args_string":"(code : String, kind : String, plugin : String, description : Nil | String, symbol : Nil | String, version : Int32)","args_html":"(code : String, kind : String, plugin : String, description : Nil | String, symbol : Nil | String, version : Int32)","location":{"filename":"src/artistry/registry.cr","line_number":13,"url":null},"def":{"name":"new","args":[{"name":"code","external_name":"code","restriction":"::String"},{"name":"kind","external_name":"kind","restriction":"::String"},{"name":"plugin","external_name":"plugin","restriction":"::String"},{"name":"description","external_name":"description","restriction":"::Nil | ::String"},{"name":"symbol","external_name":"symbol","restriction":"::Nil | ::String"},{"name":"version","external_name":"version","restriction":"::Int32"}],"visibility":"Public","body":"_ = allocate\n_.initialize(code, kind, plugin, description, symbol, version)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"code:String-instance-method","name":"code","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":6,"url":null},"def":{"name":"code","return_type":"String","visibility":"Public","body":"@code"},"external_var":false},{"html_id":"description:String|Nil-instance-method","name":"description","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":9,"url":null},"def":{"name":"description","return_type":"String | ::Nil","visibility":"Public","body":"@description"},"external_var":false},{"html_id":"kind:String-instance-method","name":"kind","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":7,"url":null},"def":{"name":"kind","return_type":"String","visibility":"Public","body":"@kind"},"external_var":false},{"html_id":"plugin:String-instance-method","name":"plugin","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":8,"url":null},"def":{"name":"plugin","return_type":"String","visibility":"Public","body":"@plugin"},"external_var":false},{"html_id":"symbol:String|Nil-instance-method","name":"symbol","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":10,"url":null},"def":{"name":"symbol","return_type":"String | ::Nil","visibility":"Public","body":"@symbol"},"external_var":false},{"html_id":"version:Int32-instance-method","name":"version","abstract":false,"location":{"filename":"src/artistry/registry.cr","line_number":11,"url":null},"def":{"name":"version","return_type":"Int32","visibility":"Public","body":"@version"},"external_var":false}]},{"html_id":"artistry/Artistry/Tag","path":"Artistry/Tag.html","kind":"class","full_name":"Artistry::Tag","name":"Tag","abstract":false,"superclass":{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/tag.cr","line_number":2,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"all:Array(Tag)-class-method","name":"all","doc":"Get all tags, ordered by name.","summary":"<p>Get all tags, ordered by name.</p>","abstract":false,"location":{"filename":"src/artistry/tag.cr","line_number":40,"url":null},"def":{"name":"all","return_type":"Array(Tag)","visibility":"Public","body":"results = [] of Tag\nArtistry.conn.query(\"SELECT id, name, created_at FROM tag ORDER BY name\") do |rs|\n  rs.each do\n    results << (Tag.new(rs.read(Int64), rs.read(String), rs.read(Int64)))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"artifacts(name:String):Array(Artifact)-class-method","name":"artifacts","doc":"Get all current artifacts with a given tag.","summary":"<p>Get all current artifacts with a given tag.</p>","abstract":false,"args":[{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(name : String) : Array(Artifact)","args_html":"(name : String) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/tag.cr","line_number":104,"url":null},"def":{"name":"artifacts","args":[{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Array(Artifact)","visibility":"Public","body":"tag = find(name)\nif tag\nelse\n  return [] of Artifact\nend\nartifacts(tag)\n"},"external_var":false},{"html_id":"artifacts(tag:Tag):Array(Artifact)-class-method","name":"artifacts","doc":"Get all current artifacts with a given tag.","summary":"<p>Get all current artifacts with a given tag.</p>","abstract":false,"args":[{"name":"tag","external_name":"tag","restriction":"Tag"}],"args_string":"(tag : Tag) : Array(Artifact)","args_html":"(tag : <a href=\"../Artistry/Tag.html\">Tag</a>) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/tag.cr","line_number":111,"url":null},"def":{"name":"artifacts","args":[{"name":"tag","external_name":"tag","restriction":"Tag"}],"return_type":"Array(Artifact)","visibility":"Public","body":"results = [] of Artifact\nArtistry.conn.query(\"SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                a.new_id, a.updated_at\\n         FROM artifact a\\n         JOIN identity i ON a.id = i.id\\n         JOIN tagging tg ON a.id = tg.artifact_id\\n         WHERE tg.tag_id = ? AND a.new_id IS NULL\\n         ORDER BY a.id\", tag.id) do |rs|\n  rs.each do\n    results << (Artifact.new(rs.read(Int64), rs.read(String), rs.read(Int32), JSON.parse(rs.read(String)), rs.read(String), rs.read(Int64), rs.read(::Union(Int64, ::Nil)), rs.read(::Union(Int64, ::Nil))))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"artifacts_all(names:Array(String)):Array(Artifact)-class-method","name":"artifacts_all","doc":"Get all current artifacts with ALL of the given tags.","summary":"<p>Get all current artifacts with ALL of the given tags.</p>","abstract":false,"args":[{"name":"names","external_name":"names","restriction":"Array(String)"}],"args_string":"(names : Array(String)) : Array(Artifact)","args_html":"(names : Array(String)) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/tag.cr","line_number":162,"url":null},"def":{"name":"artifacts_all","args":[{"name":"names","external_name":"names","restriction":"Array(String)"}],"return_type":"Array(Artifact)","visibility":"Public","body":"if names.empty?\n  return [] of Artifact\nend\nplaceholders = names.map do \"?\" end.join(\", \")\nresults = [] of Artifact\nArtistry.conn.query(\"SELECT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                a.new_id, a.updated_at\\n         FROM artifact a\\n         JOIN identity i ON a.id = i.id\\n         JOIN tagging tg ON a.id = tg.artifact_id\\n         JOIN tag t ON tg.tag_id = t.id\\n         WHERE t.name IN (#{placeholders}) AND a.new_id IS NULL\\n         GROUP BY a.id\\n         HAVING COUNT(DISTINCT t.id) = ?\\n         ORDER BY a.id\", args: names.map() do |__arg1| __arg1.as(DB::Any) end + [names.size.to_i64.as(DB::Any)]) do |rs|\n  rs.each do\n    results << (Artifact.new(rs.read(Int64), rs.read(String), rs.read(Int32), JSON.parse(rs.read(String)), rs.read(String), rs.read(Int64), rs.read(::Union(Int64, ::Nil)), rs.read(::Union(Int64, ::Nil))))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"artifacts_any(names:Array(String)):Array(Artifact)-class-method","name":"artifacts_any","doc":"Get all current artifacts with ANY of the given tags.","summary":"<p>Get all current artifacts with ANY of the given tags.</p>","abstract":false,"args":[{"name":"names","external_name":"names","restriction":"Array(String)"}],"args_string":"(names : Array(String)) : Array(Artifact)","args_html":"(names : Array(String)) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/tag.cr","line_number":135,"url":null},"def":{"name":"artifacts_any","args":[{"name":"names","external_name":"names","restriction":"Array(String)"}],"return_type":"Array(Artifact)","visibility":"Public","body":"if names.empty?\n  return [] of Artifact\nend\nplaceholders = names.map do \"?\" end.join(\", \")\nresults = [] of Artifact\nArtistry.conn.query(\"SELECT DISTINCT a.id, a.code, a.version, a.data, a.hash, i.created_at,\\n                a.new_id, a.updated_at\\n         FROM artifact a\\n         JOIN identity i ON a.id = i.id\\n         JOIN tagging tg ON a.id = tg.artifact_id\\n         JOIN tag t ON tg.tag_id = t.id\\n         WHERE t.name IN (#{placeholders}) AND a.new_id IS NULL\\n         ORDER BY a.id\", args: names.map() do |__arg0| __arg0.as(DB::Any) end) do |rs|\n  rs.each do\n    results << (Artifact.new(rs.read(Int64), rs.read(String), rs.read(Int32), JSON.parse(rs.read(String)), rs.read(String), rs.read(Int64), rs.read(::Union(Int64, ::Nil)), rs.read(::Union(Int64, ::Nil))))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"find(id:Int64):Tag|Nil-class-method","name":"find","doc":"Find tag by ID.","summary":"<p>Find tag by ID.</p>","abstract":false,"args":[{"name":"id","external_name":"id","restriction":"Int64"}],"args_string":"(id : Int64) : Tag | Nil","args_html":"(id : Int64) : <a href=\"../Artistry/Tag.html\">Tag</a> | Nil","location":{"filename":"src/artistry/tag.cr","line_number":18,"url":null},"def":{"name":"find","args":[{"name":"id","external_name":"id","restriction":"Int64"}],"return_type":"Tag | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT id, name, created_at FROM tag WHERE id = ?\", id, as: {Int64, String, Int64})\nif row\nelse\n  return nil\nend\nTag.new(row[0], row[1], row[2])\n"},"external_var":false},{"html_id":"find(name:String):Tag|Nil-class-method","name":"find","doc":"Find tag by name.","summary":"<p>Find tag by name.</p>","abstract":false,"args":[{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(name : String) : Tag | Nil","args_html":"(name : String) : <a href=\"../Artistry/Tag.html\">Tag</a> | Nil","location":{"filename":"src/artistry/tag.cr","line_number":29,"url":null},"def":{"name":"find","args":[{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Tag | ::Nil","visibility":"Public","body":"row = Artistry.conn.query_one?(\"SELECT id, name, created_at FROM tag WHERE name = ?\", name, as: {Int64, String, Int64})\nif row\nelse\n  return nil\nend\nTag.new(row[0], row[1], row[2])\n"},"external_var":false},{"html_id":"for(artifact:Artifact|Int64):Array(Tag)-class-method","name":"for","doc":"Get all tags for an artifact.","summary":"<p>Get all tags for an artifact.</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"}],"args_string":"(artifact : Artifact | Int64) : Array(Tag)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64) : Array(<a href=\"../Artistry/Tag.html\">Tag</a>)","location":{"filename":"src/artistry/tag.cr","line_number":86,"url":null},"def":{"name":"for","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"}],"return_type":"Array(Tag)","visibility":"Public","body":"artifact_id = artifact.is_a?(Artifact) ? artifact.id : artifact\nresults = [] of Tag\nArtistry.conn.query(\"SELECT t.id, t.name, t.created_at FROM tag t\\n         JOIN tagging tg ON t.id = tg.tag_id\\n         WHERE tg.artifact_id = ?\\n         ORDER BY t.name\", artifact_id) do |rs|\n  rs.each do\n    results << (Tag.new(rs.read(Int64), rs.read(String), rs.read(Int64)))\n  end\nend\nresults\n"},"external_var":false},{"html_id":"sync(artifact:Artifact|Int64,names:Array(String)):Nil-class-method","name":"sync","doc":"Replace all tags on an artifact with the given set.","summary":"<p>Replace all tags on an artifact with the given set.</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"names","external_name":"names","restriction":"Array(String)"}],"args_string":"(artifact : Artifact | Int64, names : Array(String)) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, names : Array(String)) : Nil","location":{"filename":"src/artistry/tag.cr","line_number":77,"url":null},"def":{"name":"sync","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"names","external_name":"names","restriction":"Array(String)"}],"return_type":"Nil","visibility":"Public","body":"artifact_id = artifact.is_a?(Artifact) ? artifact.id : artifact\nArtistry.conn.exec(\"DELETE FROM tagging WHERE artifact_id = ?\", artifact_id)\nnames.each do |name|\n  tag(artifact_id, name)\nend\n"},"external_var":false},{"html_id":"tag(artifact:Artifact|Int64,name:String):Nil-class-method","name":"tag","doc":"Tag an artifact. Creates the tag if it doesn't exist.","summary":"<p>Tag an artifact.</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, name : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, name : String) : Nil","location":{"filename":"src/artistry/tag.cr","line_number":56,"url":null},"def":{"name":"tag","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"tag = create(name)\nartifact_id = artifact.is_a?(Artifact) ? artifact.id : artifact\nArtistry.conn.exec(\"INSERT OR IGNORE INTO tagging (tag_id, artifact_id) VALUES (?, ?)\", tag.id, artifact_id)\n"},"external_var":false},{"html_id":"untag(artifact:Artifact|Int64,name:String):Nil-class-method","name":"untag","doc":"Remove a tag from an artifact.","summary":"<p>Remove a tag from an artifact.</p>","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, name : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, name : String) : Nil","location":{"filename":"src/artistry/tag.cr","line_number":66,"url":null},"def":{"name":"untag","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"tag = find(name)\nif tag\nelse\n  return\nend\nartifact_id = artifact.is_a?(Artifact) ? artifact.id : artifact\nArtistry.conn.exec(\"DELETE FROM tagging WHERE tag_id = ? AND artifact_id = ?\", tag.id, artifact_id)\n"},"external_var":false}],"constructors":[{"html_id":"create(name:String):Tag-class-method","name":"create","doc":"Find or create a tag by name.","summary":"<p>Find or create a tag by name.</p>","abstract":false,"args":[{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(name : String) : Tag","args_html":"(name : String) : <a href=\"../Artistry/Tag.html\">Tag</a>","location":{"filename":"src/artistry/tag.cr","line_number":11,"url":null},"def":{"name":"create","args":[{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Tag","visibility":"Public","body":"db = Artistry.conn\ndb.exec(\"INSERT OR IGNORE INTO tag (name) VALUES (?)\", name)\n(find(name)).not_nil!\n"},"external_var":false},{"html_id":"new(id:Int64,name:String,created_at:Int64)-class-method","name":"new","abstract":false,"args":[{"name":"id","external_name":"id","restriction":"::Int64"},{"name":"name","external_name":"name","restriction":"::String"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"}],"args_string":"(id : Int64, name : String, created_at : Int64)","args_html":"(id : Int64, name : String, created_at : Int64)","location":{"filename":"src/artistry/tag.cr","line_number":7,"url":null},"def":{"name":"new","args":[{"name":"id","external_name":"id","restriction":"::Int64"},{"name":"name","external_name":"name","restriction":"::String"},{"name":"created_at","external_name":"created_at","restriction":"::Int64"}],"visibility":"Public","body":"_ = allocate\n_.initialize(id, name, created_at)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"created_at:Int64-instance-method","name":"created_at","abstract":false,"location":{"filename":"src/artistry/tag.cr","line_number":5,"url":null},"def":{"name":"created_at","return_type":"Int64","visibility":"Public","body":"@created_at"},"external_var":false},{"html_id":"delete:Nil-instance-method","name":"delete","doc":"Delete this tag (CASCADE removes all taggings).","summary":"<p>Delete this tag (CASCADE removes all taggings).</p>","abstract":false,"location":{"filename":"src/artistry/tag.cr","line_number":51,"url":null},"def":{"name":"delete","return_type":"Nil","visibility":"Public","body":"Artistry.conn.exec(\"DELETE FROM tag WHERE id = ?\", id)"},"external_var":false},{"html_id":"id:Int64-instance-method","name":"id","abstract":false,"location":{"filename":"src/artistry/tag.cr","line_number":3,"url":null},"def":{"name":"id","return_type":"Int64","visibility":"Public","body":"@id"},"external_var":false},{"html_id":"name:String-instance-method","name":"name","abstract":false,"location":{"filename":"src/artistry/tag.cr","line_number":4,"url":null},"def":{"name":"name","return_type":"String","visibility":"Public","body":"@name"},"external_var":false}]},{"html_id":"artistry/Artistry/Transaction","path":"Artistry/Transaction.html","kind":"class","full_name":"Artistry::Transaction","name":"Transaction","abstract":false,"superclass":{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/transaction.cr","line_number":2,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"constructors":[{"html_id":"new(tx:DB::Transaction)-class-method","name":"new","abstract":false,"args":[{"name":"tx","external_name":"tx","restriction":"DB::Transaction"}],"args_string":"(tx : DB::Transaction)","args_html":"(tx : DB::Transaction)","location":{"filename":"src/artistry/transaction.cr","line_number":3,"url":null},"def":{"name":"new","args":[{"name":"tx","external_name":"tx","restriction":"DB::Transaction"}],"visibility":"Public","body":"_ = allocate\n_.initialize(tx)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"commit:Nil-instance-method","name":"commit","abstract":false,"location":{"filename":"src/artistry/transaction.cr","line_number":79,"url":null},"def":{"name":"commit","return_type":"Nil","visibility":"Public","body":"@tx.commit"},"external_var":false},{"html_id":"create(plugin:String,kind:String,data):Artifact-instance-method","name":"create","abstract":false,"args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"args_string":"(plugin : String, kind : String, data) : Artifact","args_html":"(plugin : String, kind : String, data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/transaction.cr","line_number":12,"url":null},"def":{"name":"create","args":[{"name":"plugin","external_name":"plugin","restriction":"String"},{"name":"kind","external_name":"kind","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"Artifact.create(plugin, kind, data)"},"external_var":false},{"html_id":"create(kind_or_code:String,data):Artifact-instance-method","name":"create","abstract":false,"args":[{"name":"kind_or_code","external_name":"kind_or_code","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"args_string":"(kind_or_code : String, data) : Artifact","args_html":"(kind_or_code : String, data) : <a href=\"../Artistry/Artifact.html\">Artifact</a>","location":{"filename":"src/artistry/transaction.cr","line_number":8,"url":null},"def":{"name":"create","args":[{"name":"kind_or_code","external_name":"kind_or_code","restriction":"String"},{"name":"data","external_name":"data","restriction":""}],"return_type":"Artifact","visibility":"Public","body":"Artifact.create(kind_or_code, data)"},"external_var":false},{"html_id":"find(id:Int64):Artifact|Nil-instance-method","name":"find","abstract":false,"args":[{"name":"id","external_name":"id","restriction":"Int64"}],"args_string":"(id : Int64) : Artifact | Nil","args_html":"(id : Int64) : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Nil","location":{"filename":"src/artistry/transaction.cr","line_number":16,"url":null},"def":{"name":"find","args":[{"name":"id","external_name":"id","restriction":"Int64"}],"return_type":"Artifact | ::Nil","visibility":"Public","body":"Artifact.find(id)"},"external_var":false},{"html_id":"find(slug:String):Artifact|Nil-instance-method","name":"find","abstract":false,"args":[{"name":"slug","external_name":"slug","restriction":"String"}],"args_string":"(slug : String) : Artifact | Nil","args_html":"(slug : String) : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Nil","location":{"filename":"src/artistry/transaction.cr","line_number":20,"url":null},"def":{"name":"find","args":[{"name":"slug","external_name":"slug","restriction":"String"}],"return_type":"Artifact | ::Nil","visibility":"Public","body":"Artifact.find(slug)"},"external_var":false},{"html_id":"link(from:Artifact|Int64,to:Artifact|Int64,rel:String,data=nil):Link-instance-method","name":"link","abstract":false,"args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"args_string":"(from : Artifact | Int64, to : Artifact | Int64, rel : String, data = nil) : Link","args_html":"(from : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, to : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String, data = <span class=\"n\">nil</span>) : <a href=\"../Artistry/Link.html\">Link</a>","location":{"filename":"src/artistry/transaction.cr","line_number":52,"url":null},"def":{"name":"link","args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"},{"name":"data","default_value":"nil","external_name":"data","restriction":""}],"return_type":"Link","visibility":"Public","body":"Link.create(from, to, rel, data)"},"external_var":false},{"html_id":"links_from(artifact:Artifact|Int64,rel:String|Nil=nil):Array(Link)-instance-method","name":"links_from","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"args_string":"(artifact : Artifact | Int64, rel : String | Nil = nil) : Array(Link)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String | Nil = <span class=\"n\">nil</span>) : Array(<a href=\"../Artistry/Link.html\">Link</a>)","location":{"filename":"src/artistry/transaction.cr","line_number":65,"url":null},"def":{"name":"links_from","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"return_type":"Array(Link)","visibility":"Public","body":"Link.from(artifact, rel)"},"external_var":false},{"html_id":"links_to(artifact:Artifact|Int64,rel:String|Nil=nil):Array(Link)-instance-method","name":"links_to","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"args_string":"(artifact : Artifact | Int64, rel : String | Nil = nil) : Array(Link)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String | Nil = <span class=\"n\">nil</span>) : Array(<a href=\"../Artistry/Link.html\">Link</a>)","location":{"filename":"src/artistry/transaction.cr","line_number":69,"url":null},"def":{"name":"links_to","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"rel","default_value":"nil","external_name":"rel","restriction":"String | ::Nil"}],"return_type":"Array(Link)","visibility":"Public","body":"Link.to(artifact, rel)"},"external_var":false},{"html_id":"rollback:Nil-instance-method","name":"rollback","abstract":false,"location":{"filename":"src/artistry/transaction.cr","line_number":75,"url":null},"def":{"name":"rollback","return_type":"Nil","visibility":"Public","body":"@tx.rollback"},"external_var":false},{"html_id":"sync_tags(artifact:Artifact|Int64,names:Array(String)):Nil-instance-method","name":"sync_tags","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"names","external_name":"names","restriction":"Array(String)"}],"args_string":"(artifact : Artifact | Int64, names : Array(String)) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, names : Array(String)) : Nil","location":{"filename":"src/artistry/transaction.cr","line_number":42,"url":null},"def":{"name":"sync_tags","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"names","external_name":"names","restriction":"Array(String)"}],"return_type":"Nil","visibility":"Public","body":"Tag.sync(artifact, names)"},"external_var":false},{"html_id":"tag(artifact:Artifact|Int64,name:String):Nil-instance-method","name":"tag","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, name : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, name : String) : Nil","location":{"filename":"src/artistry/transaction.cr","line_number":34,"url":null},"def":{"name":"tag","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"Tag.tag(artifact, name)"},"external_var":false},{"html_id":"tags_for(artifact:Artifact|Int64):Array(Tag)-instance-method","name":"tags_for","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"}],"args_string":"(artifact : Artifact | Int64) : Array(Tag)","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64) : Array(<a href=\"../Artistry/Tag.html\">Tag</a>)","location":{"filename":"src/artistry/transaction.cr","line_number":46,"url":null},"def":{"name":"tags_for","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"}],"return_type":"Array(Tag)","visibility":"Public","body":"Tag.for(artifact)"},"external_var":false},{"html_id":"unlink(from:Artifact|Int64,to:Artifact|Int64,rel:String):Nil-instance-method","name":"unlink","abstract":false,"args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"args_string":"(from : Artifact | Int64, to : Artifact | Int64, rel : String) : Nil","args_html":"(from : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, to : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, rel : String) : Nil","location":{"filename":"src/artistry/transaction.cr","line_number":56,"url":null},"def":{"name":"unlink","args":[{"name":"from","external_name":"from","restriction":"Artifact | Int64"},{"name":"to","external_name":"to","restriction":"Artifact | Int64"},{"name":"rel","external_name":"rel","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"found = Link.find(from.is_a?(Artifact) ? from.id : from, to.is_a?(Artifact) ? to.id : to, rel)\nfound.try(&.delete)\n"},"external_var":false},{"html_id":"untag(artifact:Artifact|Int64,name:String):Nil-instance-method","name":"untag","abstract":false,"args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"args_string":"(artifact : Artifact | Int64, name : String) : Nil","args_html":"(artifact : <a href=\"../Artistry/Artifact.html\">Artifact</a> | Int64, name : String) : Nil","location":{"filename":"src/artistry/transaction.cr","line_number":38,"url":null},"def":{"name":"untag","args":[{"name":"artifact","external_name":"artifact","restriction":"Artifact | Int64"},{"name":"name","external_name":"name","restriction":"String"}],"return_type":"Nil","visibility":"Public","body":"Tag.untag(artifact, name)"},"external_var":false},{"html_id":"where(code:String,include_superseded:Bool=false):Array(Artifact)-instance-method","name":"where","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"args_string":"(code : String, include_superseded : Bool = false) : Array(Artifact)","args_html":"(code : String, include_superseded : Bool = <span class=\"n\">false</span>) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/transaction.cr","line_number":24,"url":null},"def":{"name":"where","args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"return_type":"Array(Artifact)","visibility":"Public","body":"Artifact.where(code, include_superseded)"},"external_var":false},{"html_id":"where(code:String,include_superseded:Bool=false,**conditions):Array(Artifact)-instance-method","name":"where","abstract":false,"args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"args_string":"(code : String, include_superseded : Bool = false, **conditions) : Array(Artifact)","args_html":"(code : String, include_superseded : Bool = <span class=\"n\">false</span>, **conditions) : Array(<a href=\"../Artistry/Artifact.html\">Artifact</a>)","location":{"filename":"src/artistry/transaction.cr","line_number":28,"url":null},"def":{"name":"where","args":[{"name":"code","external_name":"code","restriction":"String"},{"name":"include_superseded","default_value":"false","external_name":"include_superseded","restriction":"Bool"}],"double_splat":{"name":"conditions","external_name":"conditions","restriction":""},"return_type":"Array(Artifact)","visibility":"Public","body":"Artifact.where(code, include_superseded, **conditions)"},"external_var":false}]},{"html_id":"artistry/Artistry/ValidationError","path":"Artistry/ValidationError.html","kind":"class","full_name":"Artistry::ValidationError","name":"ValidationError","abstract":false,"superclass":{"html_id":"artistry/Exception","kind":"class","full_name":"Exception","name":"Exception"},"ancestors":[{"html_id":"artistry/Exception","kind":"class","full_name":"Exception","name":"Exception"},{"html_id":"artistry/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/validator.cr","line_number":5,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"constructors":[{"html_id":"new(errors:Array(Artistry::ValidationError::FieldError))-class-method","name":"new","abstract":false,"args":[{"name":"errors","external_name":"errors","restriction":"::Array(::Artistry::ValidationError::FieldError)"}],"args_string":"(errors : Array(Artistry::ValidationError::FieldError))","args_html":"(errors : Array(<a href=\"../Artistry/ValidationError/FieldError.html\">Artistry::ValidationError::FieldError</a>))","location":{"filename":"src/artistry/validator.cr","line_number":10,"url":null},"def":{"name":"new","args":[{"name":"errors","external_name":"errors","restriction":"::Array(::Artistry::ValidationError::FieldError)"}],"visibility":"Public","body":"_ = allocate\n_.initialize(errors)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"errors:Array(FieldError)-instance-method","name":"errors","abstract":false,"location":{"filename":"src/artistry/validator.cr","line_number":6,"url":null},"def":{"name":"errors","return_type":"Array(FieldError)","visibility":"Public","body":"@errors"},"external_var":false}],"types":[{"html_id":"artistry/Artistry/ValidationError/FieldError","path":"Artistry/ValidationError/FieldError.html","kind":"struct","full_name":"Artistry::ValidationError::FieldError","name":"FieldError","abstract":false,"superclass":{"html_id":"artistry/Struct","kind":"struct","full_name":"Struct","name":"Struct"},"ancestors":[{"html_id":"artistry/Struct","kind":"struct","full_name":"Struct","name":"Struct"},{"html_id":"artistry/Value","kind":"struct","full_name":"Value","name":"Value"},{"html_id":"artistry/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"src/artistry/validator.cr","line_number":8,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry/ValidationError","kind":"class","full_name":"Artistry::ValidationError","name":"ValidationError"},"constructors":[{"html_id":"new(field:String,message:String)-class-method","name":"new","abstract":false,"args":[{"name":"field","external_name":"field","restriction":"String"},{"name":"message","external_name":"message","restriction":"String"}],"args_string":"(field : String, message : String)","args_html":"(field : String, message : String)","location":{"filename":"src/artistry/validator.cr","line_number":8,"url":null},"def":{"name":"new","args":[{"name":"field","external_name":"field","restriction":"String"},{"name":"message","external_name":"message","restriction":"String"}],"visibility":"Public","body":"_ = allocate\n_.initialize(field, message)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"},"external_var":false}],"instance_methods":[{"html_id":"clone-instance-method","name":"clone","abstract":false,"location":{"filename":"src/artistry/validator.cr","line_number":8,"url":null},"def":{"name":"clone","visibility":"Public","body":"self.class.new(@field.clone, @message.clone)"},"external_var":false},{"html_id":"copy_with(field_field=@field,message_message=@message)-instance-method","name":"copy_with","abstract":false,"args":[{"name":"_field","default_value":"@field","external_name":"field","restriction":""},{"name":"_message","default_value":"@message","external_name":"message","restriction":""}],"args_string":"(field _field = @field, message _message = @message)","args_html":"(field _field = @field, message _message = @message)","location":{"filename":"src/artistry/validator.cr","line_number":8,"url":null},"def":{"name":"copy_with","args":[{"name":"_field","default_value":"@field","external_name":"field","restriction":""},{"name":"_message","default_value":"@message","external_name":"message","restriction":""}],"visibility":"Public","body":"self.class.new(_field, _message)"},"external_var":false},{"html_id":"field:String-instance-method","name":"field","abstract":false,"def":{"name":"field","return_type":"String","visibility":"Public","body":"@field"},"external_var":false},{"html_id":"message:String-instance-method","name":"message","abstract":false,"def":{"name":"message","return_type":"String","visibility":"Public","body":"@message"},"external_var":false}]}]},{"html_id":"artistry/Artistry/Validator","path":"Artistry/Validator.html","kind":"module","full_name":"Artistry::Validator","name":"Validator","abstract":false,"locations":[{"filename":"src/artistry/validator.cr","line_number":19,"url":null}],"repository_name":"artistry","program":false,"enum":false,"alias":false,"const":false,"namespace":{"html_id":"artistry/Artistry","kind":"module","full_name":"Artistry","name":"Artistry"},"class_methods":[{"html_id":"apply_defaults(data:JSON::Any,schema:JSON::Any):JSON::Any-class-method","name":"apply_defaults","doc":"Apply default values from schema to data. Returns new JSON::Any with defaults filled in.","summary":"<p>Apply default values from schema to data.</p>","abstract":false,"args":[{"name":"data","external_name":"data","restriction":"JSON::Any"},{"name":"schema","external_name":"schema","restriction":"JSON::Any"}],"args_string":"(data : JSON::Any, schema : JSON::Any) : JSON::Any","args_html":"(data : JSON::Any, schema : JSON::Any) : JSON::Any","location":{"filename":"src/artistry/validator.cr","line_number":34,"url":null},"def":{"name":"apply_defaults","args":[{"name":"data","external_name":"data","restriction":"JSON::Any"},{"name":"schema","external_name":"schema","restriction":"JSON::Any"}],"return_type":"JSON::Any","visibility":"Public","body":"jargon_schema = Jargon::Schema.from_json_any(schema)\nroot = jargon_schema.root\napply_property_defaults(data, root)\n"},"external_var":false},{"html_id":"validate(data:JSON::Any,schema:JSON::Any):Nil-class-method","name":"validate","doc":"Validate data against a JSON Schema.\nRaises ValidationError if validation fails.","summary":"<p>Validate data against a JSON Schema.</p>","abstract":false,"args":[{"name":"data","external_name":"data","restriction":"JSON::Any"},{"name":"schema","external_name":"schema","restriction":"JSON::Any"}],"args_string":"(data : JSON::Any, schema : JSON::Any) : Nil","args_html":"(data : JSON::Any, schema : JSON::Any) : Nil","location":{"filename":"src/artistry/validator.cr","line_number":22,"url":null},"def":{"name":"validate","args":[{"name":"data","external_name":"data","restriction":"JSON::Any"},{"name":"schema","external_name":"schema","restriction":"JSON::Any"}],"return_type":"Nil","visibility":"Public","body":"jargon_schema = Jargon::Schema.from_json_any(schema)\ndata_hash = data.as_h? || ({} of String => JSON::Any)\nstring_errors = Jargon::Validator.validate(data_hash, jargon_schema)\n\nif string_errors.empty?\nelse\n  field_errors = string_errors.map do |msg| parse_error(msg) end\n  raise(ValidationError.new(field_errors))\nend\n"},"external_var":false}]}]}]}}